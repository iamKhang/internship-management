@model InternshipManagement.Models.ViewModels.SinhVienIndexVm
@{
    ViewData["Title"] = "Danh sách Sinh viên";
    // Nếu _ViewStart.cshtml đã set layout thì bỏ dòng dưới
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<h2 class="mb-3">Danh sách Sinh viên</h2>

@* ---- Alert TempData ---- *@
@if (TempData["Success"] is string ok && !string.IsNullOrWhiteSpace(ok))
{
    <div class="alert alert-success shadow-sm">@ok</div>
}
@if (TempData["Error"] is string err && !string.IsNullOrWhiteSpace(err))
{
    <div class="alert alert-danger shadow-sm">@err</div>
}

<form method="get" class="mb-3 p-3 bg-white rounded-3 shadow-sm">
    <div class="row g-3 align-items-end">
        <div class="col-12 col-md-6 col-lg-2">
            <label class="form-label fw-bold text-primary">Từ khóa</label>
            <input class="form-control form-control-sm" name="Keyword"
                   value="@Model?.Filter?.Keyword"
                   placeholder="Tên, quê quán hoặc mã SV" />
        </div>
        <div class="col-12 col-sm-6 col-md-4 col-lg-2">
            <label class="form-label fw-bold text-primary">Khoa</label>
            <select class="form-select form-select-sm" name="MaKhoa">
                <option value="">-- Chọn khoa --</option>
                @foreach (var opt in Model.KhoaOptions)
                {
                    <option value="@opt.Value" selected="@(opt.Selected ? "selected" : null)">@opt.Text</option>
                }
            </select>
        </div>
        <div class="col-6 col-sm-4 col-md-3 col-lg-2">
            <label class="form-label fw-bold text-primary">Năm sinh từ</label>
            <input class="form-control form-control-sm" type="number" name="NamSinhMin"
                   value="@(Model?.Filter?.NamSinhMin?.ToString())" />
        </div>
        <div class="col-6 col-sm-4 col-md-3 col-lg-2">
            <label class="form-label fw-bold text-primary">Đến</label>
            <input class="form-control form-control-sm" type="number" name="NamSinhMax"
                   value="@(Model?.Filter?.NamSinhMax?.ToString())" />
        </div>
        <div class="col-12 col-lg-auto d-flex gap-2">
            <button type="submit" class="btn btn-primary btn-sm text-white py-2">
                <i class="bi bi-funnel-fill me-1"></i> Lọc
            </button>
            <a class="btn btn-secondary btn-sm text-white py-2" href="@Url.Action("Index")">
                <i class="bi bi-arrow-clockwise me-1"></i> Xóa lọc
            </a>
            <a class="btn btn-success btn-sm text-white py-2" href="@Url.Action("Create")">
                <i class="bi bi-person-fill-add me-1"></i> Thêm SV
            </a>
        </div>
    </div>
</form>

@if (Model?.Items != null && Model.Items.Any())
{
    <div class="table-responsive">
        <table class="table table-striped table-bordered table-hover table-sm align-middle mb-0 bg-white">
            <thead class="table-primary">
                <tr>
                    <th class="text-nowrap fw-bold">Mã SV</th>
                    <th class="text-nowrap fw-bold">Họ tên</th>
                    <th class="text-nowrap fw-bold">Khoa</th>
                    <th class="text-nowrap fw-bold">Năm sinh</th>
                    <th class="text-nowrap fw-bold">Quê quán</th>
                    <th class="text-nowrap fw-bold text-end">Thao tác</th>
                </tr>
            </thead>
            <tbody>
                @foreach (var x in Model.Items)
                {
                    <tr>
                        <td class="text-monospace">@x.Masv</td>
                        <td>@x.Hotensv</td>
                        <td>@x.TenKhoa</td>
                        <td>@x.NamSinh</td>
                        <td>@x.QueQuan</td>
                        <td class="text-end text-nowrap">
                            <a class="btn btn-primary btn-sm me-1 text-white" href="@Url.Action("Details", new { id = x.Masv })" title="Xem">
                                <i class="bi bi-eye-fill"></i>
                            </a>
                            <a class="btn btn-warning btn-sm me-1 text-white" href="@Url.Action("Edit", new { id = x.Masv })" title="Sửa">
                                <i class="bi bi-pencil-square"></i>
                            </a>
                            <button type="button"
                                    class="btn btn-danger btn-sm"
                                    data-bs-toggle="modal"
                                    data-bs-target="#deleteSvModal"
                                    data-id="@x.Masv"
                                    data-name="@x.Hotensv"
                                    title="Xoá">
                                <i class="bi bi-trash"></i>
                            </button>
                        </td>
                    </tr>
                }
                @if (!Model.Items.Any())
                {
                    <tr><td colspan="6" class="text-center text-muted py-5 fs-5"><i class="bi bi-info-circle me-2"></i>Không có sinh viên</td></tr>
                }
            </tbody>
        </table>
    </div>
}
else
{
    <div class="alert alert-info">Chưa có dữ liệu phù hợp.</div>
}

@{
    var total = Model?.Paging?.TotalRows ?? 0;
    var pageSize = Math.Max(1, Model?.Paging?.PageSize ?? 20);
    var page = Math.Max(1, Model?.Paging?.PageIndex ?? 1);
    var totalPages = Math.Max(1, (int)Math.Ceiling((double)total / pageSize));
}
<nav class="mt-3" aria-label="paging">
    <ul class="pagination pagination-sm justify-content-center mb-0">
        <li class="page-item @(page <= 1 ? "disabled" : "")">
            <a class="page-link bg-primary text-white border-primary" href="@Url.Action("Index", new {
                Keyword = Model?.Filter?.Keyword,
                MaKhoa = Model?.Filter?.MaKhoa,
                NamSinhMin = Model?.Filter?.NamSinhMin,
                NamSinhMax = Model?.Filter?.NamSinhMax,
                PageIndex = page - 1,
                PageSize = pageSize
            })" aria-label="Previous">
                <i class="bi bi-chevron-left"></i>
            </a>
        </li>
        <li class="page-item disabled">
            <span class="page-link bg-white border-primary text-dark">Trang @(page) / @totalPages (Tổng: @total)</span>
        </li>
        <li class="page-item @(page >= totalPages ? "disabled" : "")">
            <a class="page-link bg-primary text-white border-primary" href="@Url.Action("Index", new {
                Keyword = Model?.Filter?.Keyword,
                MaKhoa = Model?.Filter?.MaKhoa,
                NamSinhMin = Model?.Filter?.NamSinhMin,
                NamSinhMax = Model?.Filter?.NamSinhMax,
                PageIndex = page + 1,
                PageSize = pageSize
            })" aria-label="Next">
                <i class="bi bi-chevron-right"></i>
            </a>
        </li>
    </ul>
</nav>

@* ---- Delete Modal (đặt ngoài mọi form khác) ---- *@
<div class="modal fade" id="deleteSvModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content border-0">
            <div class="modal-header">
                <h5 class="modal-title">Xác nhận xoá</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
                Bạn chắc chắn muốn xoá sinh viên <strong id="delete-name"></strong>?
                <div class="small text-muted mt-1">Thao tác này không thể hoàn tác.</div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Huỷ</button>

                <form method="post" asp-action="Delete" asp-controller="SinhVien" class="m-0">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="id" id="delete-id" />
                    <button type="submit" class="btn btn-danger">Xoá</button>
                </form>
            </div>
        </div>
    </div>
</div>

@section Scripts{
    <script>
        // Gán dữ liệu cho modal khi mở
        document.getElementById('deleteSvModal')
            ?.addEventListener('show.bs.modal', function (e) {
                const btn = e.relatedTarget;
                const id = btn?.getAttribute('data-id');
                const name = btn?.getAttribute('data-name');
                document.getElementById('delete-id').value = id || '';
                document.getElementById('delete-name').textContent = name || '';
            });
    </script>
}