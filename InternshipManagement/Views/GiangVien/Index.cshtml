@model InternshipManagement.Models.ViewModels.GiangVienIndexVm
@{
    ViewData["Title"] = "Danh sách Giảng viên";
    Layout = "~/Views/Shared/_Layout.cshtml";

    var paging = Model?.Paging ?? new InternshipManagement.Models.ViewModels.PagingRequest();
    var filter = Model?.Filter ?? new InternshipManagement.Models.ViewModels.GiangVienFilterVm();

    int pageSize = paging.PageSize <= 0 ? 20 : paging.PageSize;
    int pageIndex = paging.PageIndex <= 0 ? 1 : paging.PageIndex;

    // ✅ dùng TotalRows thay vì Total
    int total = paging.TotalRows;
    int totalPages = (int)Math.Ceiling((double)Math.Max(total, 0) / Math.Max(pageSize, 1));
}

<div class="card shadow-sm">
    <div class="card-body">
        @* Alerts *@
        @if (TempData["Success"] is string ok && !string.IsNullOrWhiteSpace(ok))
        {
            <div class="alert alert-success shadow-sm d-flex align-items-center gap-2" role="alert">
                <i class="bi bi-check-circle-fill"></i><span>@ok</span>
            </div>
        }
        @if (TempData["Error"] is string err && !string.IsNullOrWhiteSpace(err))
        {
            <div class="alert alert-danger shadow-sm d-flex align-items-center gap-2" role="alert">
                <i class="bi bi-x-circle-fill"></i><span>@err</span>
            </div>
        }

    <form method="get" class="mb-3 p-3 bg-white rounded-3 shadow-sm">
        <div class="row g-2 align-items-end flex-nowrap">
            <!-- Từ khóa -->
            <div class="col-auto">
                <label class="form-label fw-bold text-primary">Từ khóa</label>
                <input class="form-control form-control-sm" name="Keyword"
                       value="@Model?.Filter?.Keyword"
                       placeholder="Mã GV hoặc họ tên" style="width: 180px;" />
            </div>
            <!-- Khoa/Bộ môn -->
            <div class="col-auto">
                <label class="form-label fw-bold text-primary">Khoa/Bộ môn</label>
                <select class="form-select form-select-sm" name="MaKhoa" style="width: 180px;">
                    <option value="">-- Chọn khoa --</option>
                    @foreach (var opt in Model.KhoaOptions)
                    {
                        <option value="@opt.Value" selected="@(opt.Selected ? "selected" : null)">@opt.Text</option>
                    }
                </select>
            </div>
            <!-- Lương từ -->
            <div class="col-auto">
                <label class="form-label fw-bold text-primary">Lương từ</label>
                <input class="form-control form-control-sm" type="number" name="LuongMin"
                       value="@(Model?.Filter?.LuongMin?.ToString())" min="0" step="1" style="width: 100px;" />
            </div>
            <!-- Lương đến -->
            <div class="col-auto">
                <label class="form-label fw-bold text-primary">Đến</label>
                <input class="form-control form-control-sm" type="number" name="LuongMax"
                       value="@(Model?.Filter?.LuongMax?.ToString())" min="0" step="1" style="width: 100px;" />
            </div>
            <!-- Nút thao tác -->
            <div class="col-12 col-lg-auto d-flex gap-2">
                <button type="submit" class="btn btn-primary btn-sm text-white py-2 ">
                    <i class="bi bi-funnel-fill me-1"></i> Lọc
                </button>
                <a class="btn btn-secondary btn-sm text-white  py-2 " href="@Url.Action("Index")">
                    <i class="bi bi-arrow-clockwise me-1"></i> Xóa lọc
                </a>
                <a class="btn btn-success btn-sm text-white  py-2 " href="@Url.Action("Create")">
                    <i class="bi bi-person-fill-add me-1"></i> Thêm GV
                </a>
            </div>
        </div>
    </form>


        @* BẢNG *@
    <div class="table-responsive">
        <table class="table table-striped table-bordered table-hover table-sm align-middle mb-0 bg-white">
            <thead class="table-primary">
                <tr>
                    <th class="text-nowrap fw-bold">Mã GV</th>
                    <th class="text-nowrap fw-bold">Họ tên</th>
                    <th class="text-nowrap fw-bold d-none d-md-table-cell">Khoa</th>
                    <th class="text-nowrap fw-bold d-none d-lg-table-cell">Lương</th>
                    <th class="text-nowrap fw-bold text-end">Thao tác</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.Items is null || !Model.Items.Any())
                {
                    <tr>
                        <td colspan="5" class="text-center text-muted py-5 fs-5">
                            <i class="bi bi-info-circle me-2"></i> Không có dữ liệu
                        </td>
                    </tr>
                }
                else
                {
                    foreach (var gv in Model.Items)
                    {
                        <tr>
                            <td class="text-monospace">@gv.Magv</td>
                            <td class="fw-semibold">@gv.Hotengv</td>
                            <td class="d-none d-md-table-cell">@gv.TenKhoa</td>
                            <td class="d-none d-lg-table-cell">
                                @if (gv.Luong.HasValue)
                                {
                                    @gv.Luong.Value.ToString("#,##0")
                                }
                            </td>
                            <td class="text-end text-nowrap">
                                <a class="btn btn-primary btn-sm me-1 text-white" href="@Url.Action("Details", new { id = gv.Magv })" title="Xem">
                                    <i class="bi bi-eye-fill"></i>
                                </a>
                                <a class="btn btn-warning btn-sm me-1 text-white" href="@Url.Action("Edit", new { id = gv.Magv })" title="Sửa">
                                    <i class="bi bi-pencil-square"></i>
                                </a>
                                <button type="button"
                                        class="btn btn-danger btn-sm"
                                        data-bs-toggle="modal"
                                        data-bs-target="#deleteGvModal"
                                        data-id="@gv.Magv"
                                        data-name="@gv.Hotengv"
                                        title="Xóa">
                                    <i class="bi bi-trash"></i>
                                </button>
                            </td>
                        </tr>
                    }
                }
            </tbody>
        </table>
        @* PHÂN TRANG – dựa trên paging.TotalRows *@
        @if (total > 0 && total > pageSize)
        {
            <nav class="mt-3" aria-label="pagination">
                <ul class="pagination pagination-sm justify-content-center mb-0">
                    <li class="page-item @(pageIndex <= 1 ? "disabled" : "")">
                        <a class="page-link bg-primary text-white border-primary"
                           asp-action="Index"
                           asp-route-paging.PageIndex="@(pageIndex - 1)"
                           asp-route-paging.PageSize="@pageSize"
                           asp-route-filter.Keyword="@filter.Keyword"
                           asp-route-filter.MaKhoa="@filter.MaKhoa"
                           aria-label="Previous">
                            <i class="bi bi-chevron-left"></i>
                        </a>
                    </li>
                    @for (var i = 1; i <= totalPages; i++)
                    {
                        <li class="page-item @(i == pageIndex ? "active" : "")">
                            <a class="page-link @(i == pageIndex ? "bg-primary text-white border-primary" : "bg-white border-primary text-dark")"
                               asp-action="Index"
                               asp-route-paging.PageIndex="@i"
                               asp-route-paging.PageSize="@pageSize"
                               asp-route-filter.Keyword="@filter.Keyword"
                               asp-route-filter.MaKhoa="@filter.MaKhoa">
                                @i
                            </a>
                        </li>
                    }
                    <li class="page-item @(pageIndex >= totalPages ? "disabled" : "")">
                        <a class="page-link bg-primary text-white border-primary"
                           asp-action="Index"
                           asp-route-paging.PageIndex="@(pageIndex + 1)"
                           asp-route-paging.PageSize="@pageSize"
                           asp-route-filter.Keyword="@filter.Keyword"
                           asp-route-filter.MaKhoa="@filter.MaKhoa"
                           aria-label="Next">
                            <i class="bi bi-chevron-right"></i>
                        </a>
                    </li>
                </ul>
            </nav>
        }
    </div>
    </div>

    @* MODAL XOÁ – post đúng action Delete (POST) *@
    <div class="modal fade" id="deleteGvModal" tabindex="-1" aria-labelledby="deleteGvLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <form asp-action="Delete" method="post">
                    <div class="modal-header">
                        <h5 class="modal-title" id="deleteGvLabel">
                            <i class="bi bi-exclamation-triangle-fill text-danger"></i> Xác nhận xoá
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
                    </div>
                    <div class="modal-body">
                        <input type="hidden" id="delete-id" name="id" />
                        <p>
                            Bạn có chắc muốn xoá giảng viên:
                            <strong id="delete-name" class="text-danger"></strong>?
                        </p>
                        <p class="small text-muted mb-0">Thao tác này không thể hoàn tác.</p>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">Huỷ</button>
                        <button type="submit" class="btn btn-danger">Xoá</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    @section Scripts{
        <script>
            // Gán dữ liệu cho modal xoá
            document.getElementById('deleteGvModal')
                ?.addEventListener('show.bs.modal', function (e) {
                    const btn = e.relatedTarget;
                    const id = btn?.getAttribute('data-id');
                    const name = btn?.getAttribute('data-name');
                    document.getElementById('delete-id').value = id || '';
                    document.getElementById('delete-name').textContent = name || '';
                });
        </script>
    }
