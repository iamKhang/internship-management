@model InternshipManagement.Models.ViewModels.DeTaiDetailVm
@{
    ViewData["Title"] = "Chi tiết Đề tài";
}

<div class="card shadow-sm mb-3">
    <div class="card-header bg-white d-flex justify-content-between align-items-center">
        <h5 class="mb-0">Chi tiết Đề tài: <strong>@Model.TenDt</strong> <small class="text-muted">(@Model.MaDt)</small></h5>
        <a asp-controller="DeTai" asp-action="Index" class="btn btn-sm btn-outline-secondary">← Quay lại</a>
    </div>
    <div class="card-body">
        <div class="row g-3">
            <div class="col-md-6">
                <div><strong>Giảng viên:</strong> @Model.Gv_HoTenGv (@Model.Gv_MaGv)</div>
                <div><strong>Khoa:</strong> @Model.Khoa_TenKhoa (@Model.Khoa_MaKhoa) — ĐT: @Model.Khoa_DienThoai</div>
                <div><strong>Nơi thực tập:</strong> @Model.NoiThucTap</div>
                <div><strong>Kinh phí:</strong> @(Model.KinhPhi.HasValue ? String.Format("{0:#,##0} triệu", Model.KinhPhi) : "—")</div>
            </div>
            <div class="col-md-6">
                <div><strong>Học kỳ:</strong> @Model.HocKy/@Model.NamHoc</div>
                <div><strong>Số lượng tối đa:</strong> @Model.SoLuongToiDa</div>
                <div>
                    <span class="badge rounded-pill bg-primary me-2">Đã tham gia: @Model.SoThamGia</span>
                    <span class="badge rounded-pill @(Model.SoChoConLai > 0 ? "bg-success" : "bg-danger")">Còn lại: @Model.SoChoConLai</span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="card shadow-sm">
    <div class="card-header bg-white d-flex align-items-center justify-content-between">
        <h6 class="mb-0">Sinh viên đã tham gia</h6>
        <div class="small text-muted">Tổng: <strong>@Model.SoThamGia</strong></div>
    </div>
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-sm table-striped align-middle mb-0">
                <thead class="table-light">
                    <tr>
                        <th style="width:90px">Mã SV</th>
                        <th>Họ tên</th>
                        <th style="width:110px">Năm sinh</th>
                        <th>Quê quán</th>
                        <th style="width:140px">Trạng thái</th>
                        <th style="width:130px">Ngày đăng ký</th>
                        <th style="width:140px">Ngày chấp nhận</th>
                        <th style="width:90px">Kết quả</th>
                        <th>Ghi chú</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.Students.Count == 0)
                    {
                        <tr>
                            <td colspan="9" class="text-center text-muted py-4">Chưa có sinh viên tham gia</td>
                        </tr>
                    }
                    else
                    {
                        foreach (var s in Model.Students)
                        {
                            <tr>
                                <td>@s.MaSv</td>
                                <td>@s.HoTenSv</td>
                                <td>@(s.NamSinh?.ToString() ?? "—")</td>
                                <td>@(string.IsNullOrWhiteSpace(s.QueQuan) ? "—" : s.QueQuan)</td>
                                <td>
                                    @{
                                        string status = s.TrangThai switch
                                        {
                                            1 => "Đã chấp nhận",
                                            2 => "Đang thực hiện",
                                            3 => "Đã hoàn thành",
                                            _ => "—"
                                        };
                                    }
                                    @status
                                </td>
                                <td>@(s.NgayDangKy?.ToString("dd/MM/yyyy") ?? "—")</td>
                                <td>@(s.NgayChapNhan?.ToString("dd/MM/yyyy") ?? "—")</td>
                                <td>@(s.KetQua?.ToString("0.##") ?? "—")</td>
                                <td>@(string.IsNullOrWhiteSpace(s.GhiChu) ? "—" : s.GhiChu)</td>
                            </tr>
                        }
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>


@{
    var reg = (DeTaiRegistrationStatusVm?)ViewBag.Reg;
    bool isAuth = (bool)(ViewBag.IsAuthenticated ?? false);
    bool isStudent = (bool)(ViewBag.IsStudent ?? false);
    var returnUrl = Context.Request.Path + Context.Request.QueryString;
    var maDt = Model.MaDt;

    DateTime today = DateTime.Today;
    DateTime regStart, regEnd;

    // Tính theo quy ước năm học
    switch (Model.HocKy)
    {
        case 1:
            // HK1: 5/9 -> 31/12, nằm trong năm NamHoc
            regStart = new DateTime(Model.NamHoc, 9, 5);
            regEnd = new DateTime(Model.NamHoc, 12, 31);
            break;
        case 2:
            // HK2: 1/1 -> 25/5, nhưng của NĂM SAU
            regStart = new DateTime(Model.NamHoc + 1, 1, 1);
            regEnd = new DateTime(Model.NamHoc + 1, 5, 25);
            break;
        case 3:
            // HK3: 26/5 -> 4/9, nhưng của NĂM SAU
            regStart = new DateTime(Model.NamHoc + 1, 5, 26);
            regEnd = new DateTime(Model.NamHoc + 1, 9, 4);
            break;
        default:
            regStart = regEnd = today.AddDays(-1); // đóng luôn nếu dữ liệu kỳ lạ
            break;
    }

    bool registrationClosed = today < regStart || today > regEnd;
}


<div class="d-flex align-items-center gap-2 flex-wrap mt-2">
    @if (!isAuth)
    {
        <div class="d-inline-flex align-items-center mt-1 text-muted gap-2 lh-1">
            <i class="bi bi-info-circle align-middle p-1"></i>
            <span class="align-middle p-1">Đăng nhập để đăng ký</span>
        </div>
    }
    else if (registrationClosed && (reg is null || reg.ThisTrangThai is null || reg.ThisTrangThai == 4 || reg.ThisTrangThai == 5))
    {
        <div class="d-inline-flex align-items-center mt-1 text-muted gap-2 lh-1">
            <i class="bi bi-info-circle align-middle p-1"></i>
            <span class="align-middle p-1">Đã qua lượt đăng ký</span>
        </div>
    }
    else if (!isStudent)
    {
        @* GV/Admin: không hiển thị gì thêm *@
    }
    else if (Model.SoChoConLai <= 0 && (reg is null || reg.ThisTrangThai is null))
    {
        <div class="d-inline-flex align-items-center mt-1 text-muted gap-2 lh-1">
            <i class="bi bi-info-circle align-middle p-1"></i>
            <span class="align-middle p-1">Đề tài này đã đủ số lượng</span>
        </div>
    }
    else
    {
        // Quy ước: ThisTrangThai == -1 => đã có đề tài khác trong kỳ
        if (reg is null || reg.ThisTrangThai is null)
        {
            // Chưa từng đăng ký đề tài này => cho phép đăng ký
            <form asp-controller="DeTai" asp-action="DangKy" method="post" class="d-inline">
                @Html.AntiForgeryToken()
                <input type="hidden" name="maDt" value="@maDt" />
                <input type="hidden" name="returnUrl" value="@(Context.Request.Path + Context.Request.QueryString)" />
                <button type="submit" class="btn btn-sm btn-primary mt-1">Đăng ký đề tài</button>
            </form>
        }
        else if (reg.ThisTrangThai == -1)
        {
            <div class="d-inline-flex align-items-center mt-1 text-muted gap-2 lh-1">
                <i class="bi bi-info-circle align-middle p-1"></i>
                <span class="align-middle p-1">Bạn đã đăng ký đề tài khác trong học kỳ này</span>
            </div>
        }
        else if (reg.ThisTrangThai == 1 || reg.ThisTrangThai == 2 || reg.ThisTrangThai == 3)
        {
            <div class="d-inline-flex align-items-center mt-1 text-muted gap-2 lh-1">
                <i class="bi bi-info-circle align-middle p-1"></i>
                <span class="align-middle p-1">Đã đăng ký thành công</span>
            </div>
        }
        else if (reg.ThisTrangThai == 4) // Rejected
        {
            <button class="btn btn-sm btn-danger mt-1" disabled>Bạn đã bị từ chối</button>
            <form asp-controller="DeTai" asp-action="DangKy" method="post" class="d-inline">
                @Html.AntiForgeryToken()
                <input type="hidden" name="maDt" value="@maDt" />
                <input type="hidden" name="returnUrl" value="@(Context.Request.Path + Context.Request.QueryString)" />
                <button type="submit" class="btn btn-sm btn-outline-primary mt-1">Đăng ký lại</button>
            </form>
        }
        else if (reg.ThisTrangThai == 5) // Withdrawn / Hủy
        {
            <div class="d-inline-flex align-items-center mt-1 text-muted gap-2 lh-1">
                <i class="bi bi-info-circle align-middle p-1"></i>
                <span class="align-middle p-1">Bạn đã hủy đăng ký trước đó</span>
            </div>
        }
    }
</div>
