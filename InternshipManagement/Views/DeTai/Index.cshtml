@model InternshipManagement.Models.ViewModels.DeTaiIndexVm
@using Microsoft.AspNetCore.Routing
@{
    ViewData["Title"] = "Danh sách Đề tài";
}

<div class="card shadow-sm">
    <div class="card-header bg-white d-flex align-items-center justify-content-between">
        <h5 class="mb-0">Danh sách Đề tài</h5>
        <div class="small text-muted">Tổng: <strong>@Model.Paging.TotalRows</strong> bản ghi</div>
    </div>

    <div class="card shadow-sm mb-3">

        <div class="card-body">
            <form method="get" id="filterForm" class="row g-3">

                <!-- Hàng 1 -->
                <div class="col-md-2">
                    <label class="form-label">Khoa</label>
                    <select class="form-select" asp-for="Filter.MaKhoa" asp-items="Model.KhoaOptions">
                        <option value="">-- Tất cả --</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Giảng viên</label>
                    <select class="form-select" asp-for="Filter.MaGv" asp-items="Model.GiangVienOptions">
                        <option value="">-- Tất cả --</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Học kỳ</label>
                    <select class="form-select" asp-for="Filter.HocKy" asp-items="Model.HocKyOptions">
                        <option value="">-- Tất cả --</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label class="form-label">Năm học</label>
                    <select class="form-select" asp-for="Filter.NamHoc" asp-items="Model.NamHocOptions">
                        <option value="">-- Tất cả --</option>
                    </select>
                </div>

                <div class="col-auto d-flex align-items-end">
                    <button type="submit" form="filterForm" class="btn btn-primary d-flex align-items-center px-3 py-2">
                        <i class="bi bi-funnel me-1"></i> Lọc
                    </button>
                </div>
                <div class="col-auto d-flex align-items-end">
                    <a asp-action="Index" class="btn btn-outline-secondary d-flex align-items-center px-3  py-2">
                        <i class="bi-arrow-clockwise me-1"></i> Hủy
                    </a>
                </div>
                <div class="col-auto d-flex align-items-end">
                    <button type="button"
                            id="btnExport"
                            class="btn btn-success d-flex align-items-center px-3">
                        <i class="bi bi-table me-1"></i> Export
                    </button>
                </div>




                <!-- Hàng 2 -->
                <div class="col-md-2">
                    <label class="form-label">Kinh phí từ</label>
                    <input class="form-control" asp-for="Filter.MinKinhPhi" type="number" />
                </div>
                <div class="col-md-2">
                    <label class="form-label">đến</label>
                    <input class="form-control" asp-for="Filter.MaxKinhPhi" type="number" />
                </div>
                <div class="col-md-4">
                    <label class="form-label">Từ khóa</label>
                    <input class="form-control" asp-for="Filter.Keyword" placeholder="Tên đề tài..." />
                </div>
                <div class="col-md-4">
                    <label asp-for="Filter.TinhTrang" class="form-label">Tình trạng</label>
                    <select asp-for="Filter.TinhTrang" class="form-select">
                        <option value="All">-- Tất cả --</option>
                        <option value="OnlyNoStudent">Chưa có sinh viên đăng ký</option>
                        <option value="OnlyFull">Đã đủ số lượng</option>
                        <option value="OnlyNotEnough">Còn trống</option>
                    </select>
                </div>

            </form>
        </div>
    </div>


    <div class="table-responsive">
        <table class="table table-striped table-bordered table-hover table-sm align-middle mb-0 bg-white">
            <thead class="table-primary">
                <tr>
                    <th class="text-nowrap fw-bold">Mã</th>
                    <th class="text-nowrap fw-bold">Tên đề tài</th>
                    <th class="text-nowrap fw-bold">Khoa</th>
                    <th class="text-nowrap fw-bold text-center">Số lượng</th>
                    <th class="text-nowrap fw-bold">Học kỳ</th>
                    <th class="text-nowrap fw-bold text-end">Kinh phí</th>
                    <th class="text-nowrap fw-bold text-center">Hành động</th>
                </tr>
            </thead>
            <tbody>
                @if (Model.Items.Any())
                {
                    foreach (var d in Model.Items)
                    {
                        <tr>
                            <td><code class="text-monospace">@d.MaDt</code></td>
                            <td>@d.TenDt</td>
                            <td>@d.KhoaOptionVm.TenKhoa</td>
                            <td class="text-center">@d.SoChapNhan/@d.SoLuongToiDa</td>
                            <td>@d.HocKy/@d.NamHoc</td>
                            <td class="text-end text-success">@d.KinhPhi triệu</td>
                            <td class="text-center">
                                <a class="btn btn-sm btn-primary text-white"
                                   asp-action="Details"
                                   asp-route-id="@d.MaDt"
                                   title="Xem chi tiết">
                                    <i class="bi bi-eye"></i> Xem
                                </a>
                            </td>
                        </tr>
                    }
                }
                else
                {
                    <tr>
                        <td colspan="7" class="text-center text-muted py-5 fs-5">
                            <i class="bi bi-info-circle me-2"></i>Không có dữ liệu
                        </td>
                    </tr>
                }
            </tbody>
        </table>
    </div>
    <div class="card-footer bg-white">
        @{
            var total = Model.Paging.TotalRows;
            var pageIndex = Model.Paging.PageIndex <= 0 ? 1 : Model.Paging.PageIndex;
            var pageSize = Model.Paging.PageSize <= 0 ? 20 : Model.Paging.PageSize;
            var totalPages = (int)Math.Ceiling((double)total / pageSize);
        }
        <div class="d-flex justify-content-between align-items-center">
            <div>
                Trang <strong>@pageIndex</strong>/<strong>@(totalPages == 0 ? 1 : totalPages)</strong>
            </div>
            <nav>
                <ul class="pagination mb-0">
                    <li class="page-item @(pageIndex <= 1 ? "disabled" : "")">
                        <a class="page-link"
                           asp-action="Index"
                           asp-route-PageIndex="@(pageIndex - 1)"
                           asp-route-PageSize="@pageSize"
                           asp-route-Filter.MaKhoa="@Model.Filter.MaKhoa"
                           asp-route-Filter.MaGv="@(Model.Filter.MaGv?.ToString())"
                           asp-route-Filter.HocKy="@(Model.Filter.HocKy?.ToString())"
                           asp-route-Filter.NamHoc="@(Model.Filter.NamHoc?.ToString())"
                           asp-route-Filter.TinhTrang="@(Model.Filter.TinhTrang.ToString())"
                           asp-route-Filter.Keyword="@Model.Filter.Keyword"
                           asp-route-Filter.MinKinhPhi="@(Model.Filter.MinKinhPhi?.ToString())"
                           asp-route-Filter.MaxKinhPhi="@(Model.Filter.MaxKinhPhi?.ToString())">«</a>
                    </li>

                    @for (int i = Math.Max(1, pageIndex - 2); i <= Math.Min(totalPages == 0 ? 1 : totalPages, pageIndex + 2); i++)
                    {
                        <li class="page-item @(i == pageIndex ? "active" : "")">
                            <a class="page-link"
                               asp-action="Index"
                               asp-route-PageIndex="@i"
                               asp-route-PageSize="@pageSize"
                               asp-route-Filter.MaKhoa="@Model.Filter.MaKhoa"
                               asp-route-Filter.MaGv="@(Model.Filter.MaGv?.ToString())"
                               asp-route-Filter.HocKy="@(Model.Filter.HocKy?.ToString())"
                               asp-route-Filter.NamHoc="@(Model.Filter.NamHoc?.ToString())"
                               asp-route-Filter.TinhTrang="@(Model.Filter.TinhTrang.ToString())"
                               asp-route-Filter.Keyword="@Model.Filter.Keyword"
                               asp-route-Filter.MinKinhPhi="@(Model.Filter.MinKinhPhi?.ToString())"
                               asp-route-Filter.MaxKinhPhi="@(Model.Filter.MaxKinhPhi?.ToString())">@i</a>
                        </li>
                    }

                    <li class="page-item @(pageIndex >= (totalPages == 0 ? 1 : totalPages) ? "disabled" : "")">
                        <a class="page-link"
                           asp-action="Index"
                           asp-route-PageIndex="@(pageIndex + 1)"
                           asp-route-PageSize="@pageSize"
                           asp-route-Filter.MaKhoa="@Model.Filter.MaKhoa"
                           asp-route-Filter.MaGv="@(Model.Filter.MaGv?.ToString())"
                           asp-route-Filter.HocKy="@(Model.Filter.HocKy?.ToString())"
                           asp-route-Filter.NamHoc="@(Model.Filter.NamHoc?.ToString())"
                           asp-route-Filter.TinhTrang="@(Model.Filter.TinhTrang.ToString())"
                           asp-route-Filter.Keyword="@Model.Filter.Keyword"
                           asp-route-Filter.MinKinhPhi="@(Model.Filter.MinKinhPhi?.ToString())"
                           asp-route-Filter.MaxKinhPhi="@(Model.Filter.MaxKinhPhi?.ToString())">»</a>
                    </li>
                </ul>
            </nav>
        </div>
    </div>
</div>

<div class="modal fade" id="exportModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h6 class="modal-title">Xuất dữ liệu</h6>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Đóng"></button>
            </div>
            <div class="modal-body">
                Bạn có muốn <strong>kèm thông tin sinh viên</strong> (trạng thái 1/2/3, ngày đăng ký, ngày chấp nhận, kết quả, ghi chú) trong file export không?
            </div>
            <div class="modal-footer">
                <button type="button" id="btnExportBasic" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    Chỉ đề tài
                </button>
                <button type="button" id="btnExportDetail" class="btn btn-success">
                    Kèm sinh viên
                </button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
(function () {
  const form = document.getElementById('filterForm');
  const btnExport = document.getElementById('btnExport');
  const tinhTrang = document.getElementById('Filter_TinhTrang');

  const urlExport       = '@Url.Action("Export","DeTai")';
  const urlExportDetail = '@Url.Action("ExportChiTiet","DeTai")';

  // Tạo URL với query string từ form mà KHÔNG đổi action của form
  function exportWith(url) {
    const fd = new FormData(form);
    const qs = new URLSearchParams(fd).toString();
    // mở thẳng URL export (GET) với đầy đủ filter
    window.location.href = url + (qs ? ('?' + qs) : '');
  }

  // Modal Bootstrap 5
  const exportModalEl = document.getElementById('exportModal');
  const modal = new bootstrap.Modal(exportModalEl);

  // Click Export
  btnExport.addEventListener('click', function () {
    // Nếu chọn "Chưa có sinh viên đăng ký" -> export thường, khỏi hỏi
    if (tinhTrang && tinhTrang.value === 'OnlyNoStudent') {
      exportWith(urlExport);
      return;
    }
    // Ngược lại: hỏi người dùng
    modal.show();
  });

  // Nút trong modal
  document.getElementById('btnExportBasic').addEventListener('click', function () {
    modal.hide();
    exportWith(urlExport);
  });

  document.getElementById('btnExportDetail').addEventListener('click', function () {
    modal.hide();
    exportWith(urlExportDetail);
  });
})();
    </script>
}
